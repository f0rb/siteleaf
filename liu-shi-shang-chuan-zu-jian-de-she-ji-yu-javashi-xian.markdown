---
title: 流式上传组件的设计与JAVA实现
date: 2021-03-11 07:31:00 Z
permalink: streaming-upload-component
layout: post
---

“问题” ：
转存到第三方如OSS时网关会出现超时
通过网关上传文件再转存到第三方云存储服务，当文件过大，或网络拥堵时，会返回超时，但文件可以上传成功。

“原因” ：
网关从字节流发送完毕开始计时，而后端服务接收完全部字节流，解析出文件后，才开始上传
网关请求超时的计时从发送完请求报文开始，服务端先由Spring框架解析成MultipartFile，然后才开始上传到第三方，文件越大上传时间越长就有可能出现超时

“对策” ：
边接收边解析边上传
在解析到请求报文中的文件部分时，就开始将读取到的字节流输出到上传请求的字节流，这样在网关转发完请求开始计时的时候，上传的文件可能只剩下很小一部分，这样就不会出现超时了

“结果” ：

基于SpringMVC的文件上传实现通常是读取整个RequestBody，缓存到内存中，解析成MultipartFile对象后再注入到Controller的方法中，
当转存到